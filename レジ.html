<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>レジシステム</title>
    <style>
        :root { --red: #ee1c25; --blue: #0070c0; --orange: #f37021; --gray: #555; }
        body { margin: 0; background: #000; font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; user-select: none; }

        #display-area { flex: 72; background: #fff; position: relative; display: flex; justify-content: center; align-items: center; transition: background 0.3s; }
        .upside-down { transform: rotate(180deg); text-align: center; width: 100%; }
        #main-display { font-size: 140px; font-weight: bold; white-space: pre-wrap; line-height: 1.1; }
        #sub-display { position: absolute; top: 40px; left: 60px; font-size: 40px; color: #333; }

        #display-area.thanks { background: linear-gradient(135deg, #4facfe, #00f2fe) !important; color: #fff !important; }
        #display-area.maintenance { background: linear-gradient(135deg, #ff4b2b, #ffb03b) !important; color: #fff !important; }
        .warning-red { background-color: #ee1c25 !important; color: #fff !important; }
        .warning-white { background-color: #fff !important; color: #ee1c25 !important; }

        #standby-ui { display: none; transform: rotate(180deg); flex-direction: column; align-items: center; }
        .standby-msg { font-size: 45px; margin-bottom: 30px; font-weight: bold; color: #000; }
        .call-btn { width: 500px; height: 250px; background: var(--red); color: #fff; font-size: 80px; border-radius: 50px; border: 10px solid #fff; cursor: pointer; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }

        #bottom-panel { flex: 28; display: flex; background: #000; padding: 10px 20px; border-top: 2px solid #333; justify-content: space-between; align-items: center; box-sizing: border-box; }
        #keypad { display: grid; grid-template-columns: repeat(8, 105px); grid-template-rows: repeat(4, 1fr); gap: 10px; height: 92%; }
        .key { height: 100%; width: 100%; border-radius: 12px; border: none; font-size: 18px; font-weight: bold; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: 0.1s; color: #fff; }
        .num-key { font-size: 32px; background: #fff; color: #000; }
        .white { background: #fff; color: #000; }
        .gray { background: var(--gray); }
        .red { background: var(--red); }
        .blue { background: var(--blue); }
        .orange { background: var(--orange); }
        .teal { background: #008ba1; }
        .green { background: #00b050; }
        
        .active-toggle { background: #fff !important; color: #000 !important; border: 3px solid #000; }
        .tax-active { background: #fff !important; color: var(--blue) !important; border: 3px solid var(--blue); }

        @keyframes flash-confirm { 0% { background: var(--gray); } 50% { background: var(--orange); } 100% { background: var(--gray); } }
        .flashing { animation: flash-confirm 0.5s infinite; }

        #side-monitor { width: 230px; background: #111; border-radius: 15px; padding: 15px; color: #fff; border: 1px solid #444; height: 92%; display: flex; flex-direction: column; justify-content: center; }
        .monitor-label { font-size: 13px; color: #888; margin-bottom: 2px; }
        .monitor-value { font-size: 24px; text-align: right; display: block; font-family: monospace; font-weight: bold; }
    </style>
</head>
<body>

<div id="display-area">
    <div id="standard-content" class="upside-down">
        <div id="sub-display"></div>
        <div id="main-display">いらっしゃいませ</div>
    </div>
    <div id="standby-ui">
        <div class="standby-msg">御用のお客様は<br>呼び出しボタンを押してください。</div>
        <button class="call-btn" onclick="triggerCall()">呼び出し</button>
    </div>
</div>

<div id="bottom-panel">
    <div id="keypad">
        <button class="key white" onclick="btnAction(()=>quickAdd(150))">+150</button>
        <button class="key num-key" onclick="btnAction(()=>pressNum(7))">7</button>
        <button class="key num-key" onclick="btnAction(()=>pressNum(8))">8</button>
        <button class="key num-key" onclick="btnAction(()=>pressNum(9))">9</button>
        <button class="key white" style="font-size:32px;" onclick="btnAction(()=>addToTotal())">＋</button>
        <button id="tax10-btn" class="key blue" onclick="btnAction(()=>setTax(1.10,'tax10-btn'))">10%</button>
        <button id="btn-tax-hold" class="key gray" onclick="btnAction(()=>toggleFeature('taxHold'))">税率保持</button>
        <button id="btn-standby" class="key blue" onclick="btnAction(()=>toggleStandby())">待機</button>

        <button class="key white" onclick="btnAction(()=>quickAdd(100))">+100</button>
        <button class="key num-key" onclick="btnAction(()=>pressNum(4))">4</button>
        <button class="key num-key" onclick="btnAction(()=>pressNum(5))">5</button>
        <button class="key num-key" onclick="btnAction(()=>pressNum(6))">6</button>
        <button id="percent-btn" class="key white" onclick="btnAction(()=>setPercentMode())">％</button>
        <button id="tax8-btn" class="key blue" onclick="btnAction(()=>setTax(1.08,'tax8-btn'))">8%</button>
        <button id="btn-tax-display" class="key gray" onclick="btnAction(()=>toggleFeature('taxDisplay'))">税込表示</button>
        <button class="key gray" onclick="btnAction(()=>startMultiple())">複数</button>

        <button class="key white" onclick="btnAction(()=>quickAdd(50))">+50</button>
        <button class="key num-key" onclick="btnAction(()=>pressNum(1))">1</button>
        <button class="key num-key" onclick="btnAction(()=>pressNum(2))">2</button>
        <button class="key num-key" onclick="btnAction(()=>pressNum(3))">3</button>
        <button class="key teal" onclick="btnAction(()=>finalizeTotal())">支</button>
        <button class="key gray" onclick="btnAction(()=>applyDiscount())">割引</button>
        <button id="btn-disc-display" class="key gray" onclick="btnAction(()=>toggleFeature('discDisplay'))">割引表示</button>
        <button class="key red" onclick="btnAction(()=>triggerEmergency())">緊急</button>

        <button id="pause-btn" class="key orange" onclick="btnAction(()=>togglePause(), true)">休止</button>
        <button class="key num-key" onclick="btnAction(()=>pressNum(0))">0</button>
        <button class="key num-key" onclick="btnAction(()=>pressNum('00'))">00</button>
        <button class="key red" style="font-size:24px;" onclick="btnAction(()=>clearInput())">消</button>
        <button class="key green" onclick="btnAction(()=>processCheckout())">釣</button>
        <button id="btn-confirm" class="key gray" onclick="btnAction(()=>handleConfirm())">確認</button>
        <button id="btn-cong-status" class="key gray" onclick="btnAction(()=>notifyCongestionToggle())">混雑状態</button>
        <button class="key red" onclick="btnAction(()=>stopAllAlerts(), true)">×</button>
    </div>

    <div id="side-monitor">
        <div><span class="monitor-label">合計小計</span><span id="mon-subtotal" class="monitor-value">0 円</span></div>
        <div style="margin-top:15px; border-top: 1px solid #333; padding-top:10px;">
            <span class="monitor-label">現在入力</span><span id="mon-typing" class="monitor-value">-</span>
        </div>
    </div>
</div>

<script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const mainDisp = document.getElementById('main-display');
    const subDisp = document.getElementById('sub-display');
    const dispArea = document.getElementById('display-area');
    const confirmBtn = document.getElementById('btn-confirm');
    
    let currentString = "", subtotal = 0, grandTotal = 0, totalDiscountAmount = 0;
    let isPaused = false, isProcessing = false, isCongestionMode = false, activeTaxRate = 1.0;
    let isEmergency = false, isStandbyMode = false, isCalling = false, isInsufficient = false;
    let multiplePrice = null, flashInterval = null, callInterval = null;
    let isPercentMode = false, percentValue = 0;
    const features = { taxHold: false, taxDisplay: false, discDisplay: false };

    function playBeep(freq = 880, dur = 0.1, volume = 0.3) {
        const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(volume, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + dur);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + dur);
    }
    function playAlertSound() {
        [0, 0.4, 0.8, 1.2, 1.6, 2.0].forEach((t, i) => {
            setTimeout(() => {
                const freq = (i % 2 === 0) ? 660 : 523;
                const osc = audioCtx.createOscillator(); const g = audioCtx.createGain();
                osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
                g.gain.setValueAtTime(0.3, audioCtx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.6);
                osc.connect(g); g.connect(audioCtx.destination);
                osc.start(); osc.stop(audioCtx.currentTime + 0.6);
            }, t * 1000);
        });
    }
    function playCallChime() {
        const now = audioCtx.currentTime;
        const osc1 = audioCtx.createOscillator(); const g1 = audioCtx.createGain();
        osc1.frequency.setValueAtTime(659.25, now); g1.gain.setValueAtTime(0.2, now);
        g1.gain.setTargetAtTime(0, now + 1.2, 0.3); osc1.connect(g1); g1.connect(audioCtx.destination);
        osc1.start(now); osc1.stop(now + 2.5);
        const osc2 = audioCtx.createOscillator(); const g2 = audioCtx.createGain();
        osc2.frequency.setValueAtTime(523.25, now + 0.8); g2.gain.setValueAtTime(0.2, now + 0.8);
        g2.gain.setTargetAtTime(0, now + 2.0, 0.4); osc2.connect(g2); g2.connect(audioCtx.destination);
        osc2.start(now + 0.8); osc2.stop(now + 4.0);
    }
    function playChime() { [660, 880].forEach((freq, i) => { setTimeout(() => playBeep(freq, 0.5, 0.3), i * 120); }); }
    
    // 音声読み上げ（混雑ボタン有効時は一切行わない）
    function speak(text) {
        if (isCongestionMode && !isEmergency) return;
        window.speechSynthesis.cancel();
        const uttr = new SpeechSynthesisUtterance(text);
        uttr.lang = 'ja-JP'; uttr.rate = 1.1; window.speechSynthesis.speak(uttr);
    }

    function btnAction(fn, force = false) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        if (isEmergency || isPaused) { if (!force) return; playBeep(); fn(); return; }
        if (isProcessing && !isInsufficient) return;
        playBeep(); fn();
    }

    function handleConfirm() {
        if (isCalling) {
            clearInterval(callInterval); isCalling = false;
            isStandbyMode = false;
            document.getElementById('btn-standby').innerText = "待機";
            document.getElementById('btn-standby').classList.remove('active-toggle');
            confirmBtn.classList.remove('flashing'); dispArea.className = "";
            resetSystem();
        } else if (isInsufficient) {
            clearInterval(flashInterval); isInsufficient = false;
            confirmBtn.classList.remove('flashing'); dispArea.className = "";
            isProcessing = false; 
            mainDisp.style.fontSize = "140px";
            finalizeTotal(); 
        }
    }

    function resetSystem() {
        currentString = ""; subtotal = 0; grandTotal = 0; totalDiscountAmount = 0;
        isProcessing = false; multiplePrice = null; isPercentMode = false;
        isInsufficient = false; isCalling = false; dispArea.className = "";
        clearInterval(flashInterval); clearInterval(callInterval);
        confirmBtn.classList.remove('flashing');
        
        if (isStandbyMode && !isPaused) {
            document.getElementById('standard-content').style.display = "none";
            document.getElementById('standby-ui').style.display = "flex";
            subDisp.innerText = "";
        } else {
            document.getElementById('standby-ui').style.display = "none";
            document.getElementById('standard-content').style.display = "block";
            mainDisp.innerText = "いらっしゃいませ"; mainDisp.style.fontSize = "140px"; subDisp.innerText = "";
        }
        updateMonitor();
    }

    function updateMonitor() {
        document.getElementById('mon-subtotal').innerText = subtotal.toLocaleString() + " 円";
        let displayStr = (isPercentMode) ? percentValue + "%" : (multiplePrice !== null) ? multiplePrice + "×" + (currentString || "") : currentString || "-";
        document.getElementById('mon-typing').innerText = displayStr;
    }

    function pressNum(n) { if(!isProcessing) { currentString += n; updateMonitor(); } }
    function quickAdd(v) { subtotal += Math.floor(v * activeTaxRate); updateMonitor(); }
    function clearInput() { currentString = ""; multiplePrice = null; totalDiscountAmount = 0; isPercentMode = false; updateMonitor(); }
    function setTax(r, id) { if (activeTaxRate === r) { activeTaxRate = 1.0; } else { activeTaxRate = r; } document.querySelectorAll('.blue').forEach(b=>b.classList.remove('tax-active')); if(activeTaxRate !== 1.0) document.getElementById(id).classList.add('tax-active'); }
    function setPercentMode() { if (currentString !== "") { percentValue = parseInt(currentString); isPercentMode = true; currentString = ""; updateMonitor(); } }
    function startMultiple() { if (currentString !== "") { multiplePrice = parseInt(currentString); currentString = ""; updateMonitor(); } }
    function toggleFeature(k) { features[k] = !features[k]; document.getElementById('btn-' + k.replace(/[A-Z]/g, m => "-" + m.toLowerCase())).classList.toggle('active-toggle', features[k]); }

    function addToTotal() {
        let val = 0;
        if (isPercentMode) { val = Math.floor(subtotal * (percentValue / 100)); isPercentMode = false; }
        else if (multiplePrice !== null && currentString !== "") { val = Math.floor((multiplePrice * parseInt(currentString)) * activeTaxRate); }
        else if (currentString !== "") { val = Math.floor(parseInt(currentString) * activeTaxRate); }
        if (val !== 0) {
            subtotal += val; multiplePrice = null; currentString = "";
            if (!features.taxHold) { activeTaxRate = 1.0; document.querySelectorAll('.blue').forEach(b => b.classList.remove('tax-active')); }
            updateMonitor();
        }
    }

    function applyDiscount() {
        let val = (isPercentMode) ? Math.floor(subtotal * (percentValue / 100)) : parseInt(currentString) || 0;
        if (val > 0) { subtotal -= val; totalDiscountAmount += val; isPercentMode = false; currentString = ""; updateMonitor(); }
    }

    function finalizeTotal() {
        if (currentString !== "" || isPercentMode) addToTotal();
        if(subtotal <= 0 && totalDiscountAmount === 0) return;
        if (!isInsufficient && grandTotal <= 0) grandTotal = subtotal;

        let txt = grandTotal.toLocaleString() + "円";
        if (features.taxDisplay) txt += "<span style='font-size:40px'>(税込)</span>";
        if (features.discDisplay && totalDiscountAmount > 0) {
            txt += `<div style="font-size:30px; color:var(--red); margin-top:10px;">${totalDiscountAmount.toLocaleString()}円割引済</div>`;
        }
        mainDisp.innerHTML = txt; 
        subDisp.innerText = (grandTotal < subtotal) ? "不足額" : "合計";

        // 読み上げ：合計金額はxx円です。
        speak(`合計金額は${grandTotal}円です。`);
    }

    async function processCheckout() {
        if(currentString === "" || grandTotal <= 0) return;
        isProcessing = true;
        let pay = parseInt(currentString); currentString = ""; updateMonitor();
        mainDisp.innerText = pay.toLocaleString() + "円"; subDisp.innerText = "お預かり";
        
        // 読み上げ：xx円お預かりします。
        speak(`${pay}円、お預かりします。`);
        
        // 待機：通常 4秒 / 混雑 3秒
        await new Promise(r => setTimeout(r, isCongestionMode ? 3000 : 4000));
        
        if (pay < grandTotal) {
            grandTotal -= pay; 
            isInsufficient = true; confirmBtn.classList.add('flashing');
            playAlertSound();
            mainDisp.innerText = "投入金額が\n不足しています"; subDisp.innerText = ""; mainDisp.style.fontSize = "70px";
            
            // 読み上げ：xx円不足しています。
            speak(`${grandTotal}円、ふそくしています。`);
            
            let i = 0;
            flashInterval = setInterval(() => {
                if (!isInsufficient) return;
                dispArea.className = (i % 2 === 0) ? "warning-red" : "warning-white";
                i++;
            }, 400);
        } else {
            let change = pay - grandTotal; playChime();
            mainDisp.innerText = change.toLocaleString() + "円";
            subDisp.innerText = "お釣り";
            
            // 読み上げ：おつりは、xx円です。お買い上げありがとうございました。
            speak(`おつりは、${change}円です。お買い上げありがとうございました。`);
            
            // 待機：通常 5秒 / 混雑 4秒
            await new Promise(r => setTimeout(r, isCongestionMode ? 4000 : 5000));

            // お礼の表示：通常 3秒 / 混雑 0秒（即終了）
            if (!isCongestionMode) {
                dispArea.classList.add('thanks');
                mainDisp.style.fontSize = "80px";
                mainDisp.innerText = "お買い上げ\nありがとうございました";
                subDisp.innerText = "";
                await new Promise(r => setTimeout(r, 3000));
            }
            
            resetSystem();
        }
    }

    function triggerEmergency() {
        resetSystem(); isEmergency = true; 
        mainDisp.innerText = "緊急事態発生\n店員の指示に従ってください"; mainDisp.style.fontSize = "60px";
        triggerEmergencyLoop();
    }
    async function triggerEmergencyLoop() {
        while(isEmergency) {
            playBeep(440, 0.5); dispArea.className = (dispArea.className === "warning-red") ? "warning-white" : "warning-red";
            await new Promise(r => setTimeout(r, 500));
        }
    }

    function togglePause() {
        const pBtn = document.getElementById('pause-btn');
        if(!isPaused) {
            resetSystem(); isPaused = true; 
            dispArea.classList.add('maintenance');
            mainDisp.innerText = "休止中\nしばらくお待ち下さい"; mainDisp.style.fontSize = "70px";
            pBtn.innerText = "再開"; pBtn.className = "key white";
        } else {
            isPaused = false; pBtn.innerText = "休止"; pBtn.className = "key orange";
            resetSystem();
        }
    }

    function stopAllAlerts() { isEmergency = false; isPaused = false; resetSystem(); }
    function triggerCall() { if (isCalling) return; isCalling = true; confirmBtn.classList.add('flashing'); const callSeq = () => { if (!isCalling) return; playCallChime(); }; callSeq(); callInterval = setInterval(callSeq, 4500); }
    function toggleStandby() { isStandbyMode = !isStandbyMode; document.getElementById('btn-standby').classList.toggle('active-toggle', isStandbyMode); resetSystem(); }
    async function notifyCongestionToggle() { isCongestionMode = !isCongestionMode; document.getElementById('btn-cong-status').classList.toggle('active-toggle', isCongestionMode); resetSystem(); }

    updateMonitor();
</script>
</body>
</html>
